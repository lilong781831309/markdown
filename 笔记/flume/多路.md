#### 功能

自定义 Interceptor,将不同内容分到不同的下游flume中



#### 配置

netcat-memory-avro.conf

```shell
# Name
a1.sources = r1
a1.sinks = k1 k2 k3
a1.channels = c1 c2 c3

# Source
a1.sources.r1.type = netcat
a1.sources.r1.bind = localhost
a1.sources.r1.port = 6666

#channel selector
a1.sources.r1.selector.type = multiplexing
a1.sources.r1.selector.header = state
a1.sources.r1.selector.mapping.zh = c1
a1.sources.r1.selector.mapping.en = c2
a1.sources.r1.selector.default = c3

# Interceptor
a1.sources.r1.interceptors = i1
a1.sources.r1.interceptors.i1.type = org.example.flume.interceptor.CustomeInterceptor$MyBuilder

# Sink
# sinke1
a1.sinks.k1.type = avro
a1.sinks.k1.hostname = hadoop10
a1.sinks.k1.port = 7777
# sinke2
a1.sinks.k2.type = avro
a1.sinks.k2.hostname = hadoop10
a1.sinks.k2.port = 8888
# sinke3
a1.sinks.k3.type = avro
a1.sinks.k3.hostname = hadoop10
a1.sinks.k3.port = 9999

# Channel
# channel1
a1.channels.c1.type = memory
a1.channels.c1.capacity = 1000
a1.channels.c1.transactionCapacity = 100
# channel2
a1.channels.c2.type = memory
a1.channels.c2.capacity = 1000
a1.channels.c2.transactionCapacity = 100
# channel3
a1.channels.c3.type = memory
a1.channels.c3.capacity = 1000
a1.channels.c3.transactionCapacity = 100

# Bind
a1.sources.r1.channels = c1 c2 c3
a1.sinks.k1.channel = c1
a1.sinks.k2.channel = c2
a1.sinks.k3.channel = c3
```



avro-memory-logger-zh.conf

```shell
# Name
a1.sources = r1
a1.sinks = k1
a1.channels = c1

# Source
a1.sources.r1.type = avro
a1.sources.r1.bind = hadoop10
a1.sources.r1.port = 7777

# Sink
a1.sinks.k1.type = logger

# Channel
a1.channels.c1.type = memory
a1.channels.c1.capacity = 1000
a1.channels.c1.transactionCapacity = 100

# Bind
a1.sources.r1.channels = c1
a1.sinks.k1.channel = c1
```



avro-memory-logger-en.conf

```shell
# Name
a1.sources = r1
a1.sinks = k1
a1.channels = c1

# Source
a1.sources.r1.type = avro
a1.sources.r1.bind = hadoop10
a1.sources.r1.port = 8888

# Sink
a1.sinks.k1.type = logger

# Channel
a1.channels.c1.type = memory
a1.channels.c1.capacity = 1000
a1.channels.c1.transactionCapacity = 100

# Bind
a1.sources.r1.channels = c1
a1.sinks.k1.channel = c1
```



avro-memory-logger-default.conf

```shell
# Name
a1.sources = r1
a1.sinks = k1
a1.channels = c1

# Source
a1.sources.r1.type = avro
a1.sources.r1.bind = hadoop10
a1.sources.r1.port = 9999

# Sink
a1.sinks.k1.type = logger

# Channel
a1.channels.c1.type = memory
a1.channels.c1.capacity = 1000
a1.channels.c1.transactionCapacity = 100

# Bind
a1.sources.r1.channels = c1
a1.sinks.k1.channel = c1
```



#### 自定义 Interceptor

打包上传到flume的lib目录

```java
package org.example.flume.interceptor;

import org.apache.flume.Context;
import org.apache.flume.Event;
import org.apache.flume.interceptor.Interceptor;

import java.nio.charset.StandardCharsets;
import java.util.List;

public class CustomeInterceptor implements Interceptor {

    @Override
    public void initialize() {

    }

    @Override
    public Event intercept(Event event) {
        String body = new String(event.getBody(), StandardCharsets.UTF_8);
        if (body.startsWith("lilong")) {
            event.getHeaders().put("state", "zh");
        } else if (body.startsWith("long li")) {
            event.getHeaders().put("state", "en");
        }else{
            event.getHeaders().put("state", "default");
        }
        return event;
    }

    @Override
    public List<Event> intercept(List<Event> list) {
        return null;
    }

    @Override
    public void close() {

    }

    public static class MyBuilder implements Builder {

        @Override
        public Interceptor build() {
            return new CustomeInterceptor();
        }

        @Override
        public void configure(Context context) {

        }
    }
}
```



#### 启动

```shell
flume-ng agent --conf $FLUME_HOME/conf --conf-file $FLUME_HOME/conf-file/multiplexing/avro-memory-logger-zh.conf --name a1 -Dflume.root.logger=INFO,console

flume-ng agent --conf $FLUME_HOME/conf --conf-file $FLUME_HOME/conf-file/multiplexing/avro-memory-logger-en.conf --name a1 -Dflume.root.logger=INFO,console

flume-ng agent --conf $FLUME_HOME/conf --conf-file $FLUME_HOME/conf-file/multiplexing/avro-memory-logger-default.conf --name a1 -Dflume.root.logger=INFO,console

flume-ng agent --conf $FLUME_HOME/conf --conf-file $FLUME_HOME/conf-file/multiplexing/netcat-memory-avro.conf --name a1 -Dflume.root.logger=INFO,console
```

