[TOC]

#### 1、useradd 添加用户

```shell
useradd 选项 用户名	

常用的选项有：
    -c comment 指定一段注释性描述。
    -d 目录 指定用户主目录，如果此目录不存在，则同时使用-m选项，可以创建主目录。
    -g 用户组 指定用户所属的用户组。
    -G 用户组，用户组 指定用户所属的附加组。
    -s Shell文件 指定用户的登录Shell。
    -u 用户号 指定用户的用户号，如果同时有-o选项，则可以重复使用其他用户的标识号。

useradd添加用户时出现错误: Creating mailbox file: File exists
linux下添加用户后，会在系统里自动加一个邮箱(系统邮箱),路径是 /var/spool/mail/用户名
可以直接用命令 rm -rf /var/spool/mail/用户名,这样就可以再次添加同一名字的用户
```

#### 2、userdel 删除用户
```shell
userdel  选项  用户名

1)、删除用户，不删除用户目录
    userdel  用户名	   
    
2)、删除用户，且删除用户目录
    userdel -r 用户名  
```

#### 3、usermod 修改用户
```shell
usermod 选项 用户名

常用的选项包括-c, -d, -m, -g, -G, -s, -u以及-o等，这些选项的意义与useradd命令中的选项一样，可以为用户指定新的资源值。

另外，有些系统可以使用选项：-l 新用户名
这个选项指定一个新的账号，即将原来的用户名改为新的用户名。

1)、将用户加入组
    usermod -g 用户组 用户名

2)、将某用户添加进多个附属组,会覆盖为"附属组"
    usermod -G 附属组1,附属组2，...,附属组X  用户名
    
3)、将某用户添加进多个附属组,不会覆盖,相当追加
    usermod -a -G 附属组1,附属组2，...,附属组X 用户名
    
4)、将用户从附属组移除
    gpasswd -d 用户 附属组
```

#### 4、用户文件
```shell
# cat  /etc/passwd

一行记录对应着一个用户，每行记录又被冒号(:)分隔为7个字段，其格式和具体含义如下：

用户名:口令:用户标识号:组标识号:注释性描述:主目录:登录Shell

用户名      :   通常长度不超过8个字符，并且由大小写字母和/或数字组成。登录名中不能有冒号(:)，因为冒号在这里是分隔符
口令        :   只存放一个特殊的字符，例如x或者*,真正的加密后的用户口令字存放到/etc/shadow文件中
组标识号    :   它对应着/etc/group文件中的一条记录
注释性描述  :   例如用户的真实姓名、电话、地址等，这个字段并没有什么实际的用途
主目录      :   它是用户在登录到系统之后所处的目录
登录Shell   :   系统管理员可以根据系统情况和用户习惯为用户指定某个Shell。如果不指定Shell，那么系统使用sh为默认的登录Shell，即这个字段的值为/bin/sh
```

#### 5、passwd 用户密码管理
```shell
passwd 选项 用户名

常用的选项有：
    -l 锁定口令，即禁用账号。
    -u 口令解锁。
    -d 使账号无口令。
    -f 强迫用户下次登录时修改口令。

修改用户密码
    passwd 用户名
```

#### 6、密码文件
```shell
/etc/shadow中的记录行与/etc/passwd中的一一对应，它由pwconv命令根据/etc/passwd中的数据自动产生
它的文件格式与/etc/passwd类似，由若干个字段组成，字段之间用":"隔开。这些字段是：

登录名:加密口令:最后一次修改时间:最小时间间隔:最大时间间隔:警告时间:不活动时间:失效时间:标志

登录名             ：  与/etc/passwd文件中的登录名相一致的用户账号
口令               ：  存放的是加密后的用户口令字，长度为13个字符。如果为空，则对应用户没有口令，登录时不需要口令；如果含有不属于集合 { ./0-9A-Za-z }中的字符，则对应的用户不能登录。
最后一次修改时间    ：  表示的是从某个时刻起，到用户最后一次修改口令时的天数。时间起点对不同的系统可能不一样。例如在SCO Linux 中，这个时间起点是1970年1月1日。
最小时间间隔        ：  指的是两次修改口令之间所需的最小天数。
最大时间间隔        ：  指的是口令保持有效的最大天数。
警告时间            ：  字段表示的是从系统开始警告用户到用户密码正式失效之间的天数。
不活动时间          ：  表示的是用户没有登录活动但账号仍能保持有效的最大天数。
失效时间            ：  字段给出的是一个绝对的天数，如果使用了这个字段，那么就给出相应账号的生存期。期满后，该账号就不再是一个合法的账号，也就不能再用来登录了。
```

#### 7、id 查看用户信息
```shell
id 用户名

显示

uid=UID(用户名) gid=GID(所属组) groups=GID(所属组),GID1(附属组1),GID2(附属组2)...
```

#### 8、su（swith user） 切换用户
```shell
1)、切换到用户并获得该用户的环境变量及执行权限
    su - 用户名称 
    
    执行的shell:
        /etc/profile
        /etc/bashrc
        ~/.bash_profile
        ~/.bashrc
    
2)、切换用户，只能获得用户的执行权限，不能获得环境变量
    su 用户名称     
            
    执行的shell:
        /etc/bashrc
        ~/.bashrc
```

#### 9、whoami 查看登录用户信息
```shell
1)、显示自身用户名称
    # whoami      

2)、显示登录用户的用户名以及登陆时间
    # who am i	
```

#### 10、添加批量用户
```shell
1)、先编辑一个文本用户文件 user.txt
按照/etc/passwd密码文件的格式书写，要注意每个用户的用户名、UID、宿主目录都不可以相同，其中密码栏可以留做空白或输入x号
user001::600:600:user:/home/user001:/bin/bash
user002::601:601:user:/home/user002:/bin/bash
user003::602:602:user:/home/user003:/bin/bash
user004::603:603:user:/home/user004:/bin/bash
user005::604:604:user:/home/user005:/bin/bash
user006::605:605:user:/home/user006:/bin/bash

2)、编辑每个用户的密码对照文件 passwd.txt
user001:123456
user002:123456
user003:123456
user004:123456
user005:123456
user006:123456

3)、以root身份执行命令 /usr/sbin/newusers
从刚创建的用户文件user.txt中导入数据，创建用户
# newusers < user.txt

4)、执行命令/usr/sbin/pwunconv
将 /etc/shadow 产生的 shadow 密码解码，然后回写到 /etc/passwd 中，并将/etc/shadow的shadow密码栏删掉。这是为了方便下一步的密码转换工作，即先取消 shadow password 功能
# pwunconv

5)、以 root 身份执行命令 /usr/sbin/chpasswd
创建用户密码，chpasswd 会将经过 /usr/bin/passwd 命令编码过的密码写入 /etc/passwd 的密码栏
# chpasswd < passwd.txt

6)、确定密码经编码写入/etc/passwd的密码栏后
执行命令 /usr/sbin/pwconv 将密码编码为 shadow password，并将结果写入 /etc/shadow
# pwconv
```

#### 11、sudo 提升用户权限
```shell
1)、以某个组的某个用户身份运行
    sudo [-g group] [-u user] 文件
   
   常用的选项有： 
        -g, –group=group    以指定的用户组或 ID 执行命令
        -u, –user=user      以指定用户或 ID 运行命令(或编辑文件)
        -e, –edit           编辑文件而非执行命令
        -s, –shell          以目标用户运行 shell；可同时指定一条命令
        -b, –background     在后台运行命令
    
2)、/etc/sudoers 配置
    格式:   USER/GROUP HOST=[(USER[:GROUP])] [NOPASSWD:] COMMANDS
            授权用户/组 主机 =[(切换到哪些用户或组)] [是否需要输入密码验证] 命令1,命令2,...
    解释:
        USER/GROUP      : 表示需要被授权的用户或者组；如果是组则需要以 % 开头
        HOST            : 表示允许从哪些主机登录的用户运行 sudo 命令；ALL 表示允许从任何终端、机器访问 
        (USER[:GROUP])  : 表示使用 sudo 可切换的用户或者组，组可以不指定；ALL 表示可以切换到系统的所有用户 
        NOPASSWD        : 如果指定，则该用户或组使用 sudo 时不必输入密码
        COMMANDS        : 表示运行指定的命令；ALL 表示允许执行所有命令,多个命令用逗号隔开 
        
    例如:
        #允许 admin 用户执行所有命令，且无需输入密码 
        admin ALL=(ALL) NOPASSWD: ALL 
            
        #仅允许 test 用户执行 echo, ls 命令 
        test ALL=(ALL) NOPASSWD: /bin/echo /bin/ls 
            
        #允许本机的用户执行关机命令 
        escape localhost=/sbin/shutdown -h now 
            
        #允许 sudo 组执行所有命令 
        %sudo ALL=(ALL:ALL) ALL 
            
        #允许 wheel 用户组中的用户像 root 用户一样使用 mount、unmount、chrom 命令 
        %wheel ALL=/sbin/mount /mnt/cdrom, /sbin/umount, /mnt/cdrom
            
        #允许 nginx 用户组中的用户使用 #/usr/lib/systemd/system/service network restart 命令 
        nginx ALL=ALL NOPASSWD:/usr/lib/systemd/system/service network restart
        
    注意:   修改 sudoers 文件建议使用 visudo 命令
            新建配置文件放到 /etc/sudoers.d/ 文件夹下,该文件夹下文件内容自动生效。文件名不能以'~'结尾，不能包含'.' ，权限必须为 0440
            (USER[:GROUP]) 可省略
            NOPASSWD 只对之后的第一个命令生效,如果有逗号隔开的多个命令,则每个都需要加上NOPASSWD才能不输入密码
            
3)、示例:
    user002用户添加 user001 附属组
    # usermod -G user001 user002
	
    # id user001
     uid=600(user001) gid=600(user001) groups=600(user001)
    # id user002
     uid=601(user002) gid=601(user002) groups=601(user002),600(user001)
    # id user003
     uid=602(user003) gid=602(user003) groups=602(user003)

    # su - user001
	# echo '# !bin/sh;' >> test.sh
	# echo 'echo "hello user001"' >> test.sh
    # chmod -R 770 /home/user001
    # exit

    # su - user002
    # /home/user001/test.sh
    输出 hello user001 (因为user002有user001附属组)
    # exit
    
    # su - user003
    # /home/user001/test.sh
    输出 -bash: /home/user001/test.sh: Permission denied (因为user003没有user001附属组)
    # exit
	
	修改配置,使 user003 能提权到 user002:user001,可以 sudo - u user002 也可以 sudo -g user001
	# echo 'user003 ALL=(user002:user001) NOPASSWD:/home/user001/test.sh' >> /etc/sudoers.d/user003
        
    # su - user003
    # sudo -u user002 -g user001 /home/user001/test.sh
    输出 hello user001 (因为sudoers 中指定 text3 能够以 user002:user001 身份执行 /home/user001/test.sh)
	
    # sudo -u user002 /home/user001/test.sh
    输出 hello user001 (因为user002有user001附属组)
	
    # exit
    将 user002从user001组中删除
    # gpasswd -d user002 user001
    
    # su - user003
    # sudo -u user002 /home/user001/test.sh
    提示输入密码,然后显示
    输出 sudo: /home/user001/test.sh: command not found (因为这时user002用户没有user001附属组)
	
    # sudo -u user002 -g user001 /home/user001/test.sh
    输出 hello user001 (因为sudoers 中指定 text3 能够以 user002:user001 身份执行 /home/user001/test.sh)
```